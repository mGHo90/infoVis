<!DOCTYPE html>
<html lang="en">
<head>
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
</head>

<style>

    text {
        font: 15px sans-serif;
    }

    rect:hover{
        stroke: red;
    }

    .axis text {
  font: 10px sans-serif;
}
    .axis line,
    .axis path {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
    }
    .path-line {
        fill: none;
        stroke: yellow;
        stroke-width: 1.5px;
    }
    svg {
        background: #f0f0f0;
    }


    rect.background {
        fill: white;
    }

    div.tooltip {
        box-sizing: border-box;
        position: absolute;
        text-align: center;
        width: border-box;
        padding: 2px;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }




    /*********d3-annotate********/

    .d3-an-container .annotation {
        cursor: move;
    }
    .d3-an-container .annotation.dragging {
        cursor: grabbing;
        cursor: -moz-grabbing;
        cursor: -webkit-grabbing;
        text-decoration: underline;
    }
    .d3-an-text-edit {
        position: fixed;
        top: 40px;
        left: 40px;
    }


</style>

<body>
<script>
    
    /*
    var myName = "{{tA_id}}";
    var initOpts = {};
    var formValues = JSON.parse(localStorage.getItem(myName)) || initOpts;
    formValues["buttonText"] = $button.text();
    localStorage.setItem(myName, JSON.stringify(formValues));

    var anots = {};
            .on("click", function (d) {
                            //store annotations
                            //anots[d.id] = 1;
                            d.good = 1;
                            //console.log(hsNodeName);
                            //localStorage.setItem(hsNodeName, JSON.stringify(anots));
                        })


    var me = JSON.parse(localStorage.getItem(myName));
    console.log(me);
    onsole.log(myName);




    */



    //button width and height
    var bWidth= 40; //button width
    var bHeight= 25; //button height
    var bSpace= 10; //space between buttons
    var x0= 20; //x offset
    var y0= 10; //y offset

    var width = 1000;
    var height = 800;
    var margin = 100;
    var numOfLayers = 4;
    var area_width  = 200;
    var area_height = 200;
    var yoffset = 50;
    var myData;
    var left_margin = right_margin = 10;
    var bandScale = d3.scaleBand()
            .range([0, 1000])
            .padding(0.3);
    var indx;
    var arr = new Array();
    var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);
    var visPath;
    var path;






    var spacing  = width / (numOfLayers + 1);

    //console.log(myScale(1) - spacing);



    var canvas = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height);
    //.append("g");

    var back  = canvas.append("g")
            .attr("class", "back")
            .attr("fill", "white");

    back.append("rect")
            .attr("width", width)
            .attr("height", height)
            .on("click", down);



    var GroupSelector = canvas.append("g");
    var rectGroup = GroupSelector.selectAll("rect");


    //GroupSelector.append("rect").attr("width",1000).attr("height", 1000).("background", "white").on("click", function(){console.log("fuck you");});


    d3.json("laskaData.json", function(error, data) {

        if (error) {  //If error is not null, something went wrong.
            console.log(error);  //Log the error.
        } else {      //If no error, the file loaded correctly. Yay!
            //console.log(data);//Log the data.
        }

        myData = data;
        down(myData,0);


    });





    function down (d, i) {

        if(!d){ d = myData}

        bandScale.domain(myData
                .filter(function(d,i) {
                    return d.Name[d.Name.length -1] != myData[Math.abs(i-1)].Name[myData[Math.abs(i-1)].Name.length -1]; })
                .map(function (d,i) {
                    return d.Name;
                }));
        boxwidth = bandScale.bandwidth();

        canvas.selectAll(".panel").remove();

        canvas.selectAll(".button").remove();

        var exitFilter = canvas.selectAll(".filters")
                .attr("class", "exitFilters");


        // Transition exiting bars to fade out.
        var exitFilterTransition = exitFilter.remove();



        /************************************************
        *******Individual rectangles on first page*******
        *************************************************/
        var rectangle = rectGroup.data(d)
                .enter();


        var appendix = rectangle.append("rect")
                .attr("class", "enter")
                .attr("x", function (d, i) {
                    indx = i;
                    while(bandScale(myData[indx].Name) == null){
                        indx--;
                        arr[i] = indx;
                    }
                    //console.log(arr[0]);
                    return bandScale(myData[indx].Name);})
                .attr("y", function (d, i) {
                    if(arr[i] != null){
                        //console.log(Math.abs(arr[i]-i));
                        return (yoffset+Math.abs(arr[i]-i) * bandScale.bandwidth() + Math.abs(arr[i]-i) * bandScale.bandwidth()*0.1);
                    } else {
                        return yoffset;
                    }
                })
                .attr("rx", "15")
                .attr("ry", "15")
                .attr("id", function(d){ return d.id; })
                .attr("height", function () { return bandScale.bandwidth(); })
                .attr("width", function () {return bandScale.bandwidth();} )
                .attr("fill", "white")
                .attr("stroke", "blue")
                .style("cursor", function(d) { return !d.Children ? null : "pointer"; })
                .on("mouseover", function(d) {
                    var shoop = JSON.stringify(d,["Name","FilterSize","Input", "Output", "InputSize", "NumChannels",
                        "NumFilters", "Stride", "Padding", "WindowChannelSize", "Alpha", "Beta", "K", "PoolSize",
                        "WeightLearnRateFactor", "WeightL2Factor", "BiasLearnRateFactor", "BiasL2Factor",
                        "OutputSize", "LossFunction", "crossentropyex", "Probability"]);
                    shoop = shoop.replace (/,"/g,"<br>");
                    shoop = shoop.replace(/[{}]/g, "");
                    shoop = shoop.replace(/"/g, "");
                    shoop = shoop.replace(/:/g," : " );
                    var leftshift = parseInt(d3.select(this).attr("x")) + boxwidth;
                    leftshift = leftshift.toString()

                    div.transition()
                            .duration(200)
                            .style("opacity", .9);
                    div	.html(shoop)
                            .style("left", leftshift + "px")
                            .style("top", d3.select(this).attr("y")  + "px");
                })
                .on("mouseout", function(d) {
                    div.transition()
                            .duration(500)
                            .style("opacity", 0);
                })
                .on("click", inner);



        var labels = canvas.selectAll("text")
                .data(d)
                .enter()
                .append("text")
                .attr("class", "enter")
                .attr("x", function (d, i) {
                    indx = i;
                    while(bandScale(myData[indx].Name) == null){
                        indx--;
                        arr[i] = indx;
                    }
                    return bandScale(myData[indx].Name) + (bandScale.bandwidth() / 2) - (this.getBBox().width / 2);})
                .attr("y", function (d, i) {
                    if(arr[i] != null){
                        return (yoffset+Math.abs(arr[i]-i) * bandScale.bandwidth()
                        + Math.abs(arr[i]-i) * bandScale.bandwidth()*0.1
                        +(bandScale.bandwidth() / 2));
                    } else {
                        return yoffset+(bandScale.bandwidth() / 2);
                    }
                })
                .text(function (d) {
                    //hshere
                    var count = 0;
                    if(d.Children){
                        d.Children.forEach(function(d) {
                            if(d.good){
                                count = count + d.good;
                            }
                        });
                    }
                    
                    
                    var k =  d.Name + ":" + count;
                    return k;
                })
                .attr("text-anchor", "middle");
    }






    function inner (d, i) {

        var hsNodeName = d.Name; //hashname the annotations are save with on clients 

        var path;
        var quantity = d.Children.length;
        var divideBy = Math.ceil( Math.sqrt(quantity) );//square of this number is the number of mini squares we have
        var widthBox = (width * 0.8)/divideBy;
        var yOffset = width - height;
        var path = "http://35.163.48.45:8888/laskaback/";

        if (!d.Children){return}
        var exit = canvas.selectAll(".enter")
                .attr("class", "exit");


        // Transition exiting bars to fade out.
        var exitTransition = exit.transition()
                .duration(750)
                .style("opacity", 1e-6)
                .remove();

        div.transition()
                .duration(500)
                .style("opacity", 0);


        //adding buttons
        /************************************************
        *****boundary of filter boxes as button**********
        *************************************************/
        canvas.append("rect")
                .attr("class", "button")
                .attr("x", (width - 60) )
                .attr("y", 0 )
                .attr("rx", 5)
                .attr("ry", 5 )
                .attr("height", 30)
                .attr("width",  60 * 0.9)
                .attr("fill","navy")
                .on("click", function () {
                    var temp = (document.getElementsByName("image")[0].href.baseVal).split("/");
                    temp = temp[temp.length - 2];
                    if(temp === 'laskaback'){
                        path = "http://35.163.48.45:8888/laskaactivations/";
                    }
                    else{
                        path = "http://35.163.48.45:8888/laskaback/";
                    }

                    canvas.selectAll(".filters")
                            .attr("xlink:href",  function(d) { return path + d.img;})
                    return;
                });


        /************************************************
        *****************toggle button*******************
        *************************************************/
        canvas.append("text")
                .attr("class", "button")
                .attr("x", (width - 30))
                .attr("y", 15)
                .attr("dy", ".35em")
                .text("toggle")
                .attr("text-anchor", "middle")
                .style("cursor", "pointer")
                .attr("fill", "white")
                .on("click", function () {
                    var temp = (document.getElementsByName("image")[0].href.baseVal).split("/");
                    temp = temp[temp.length - 2];
                    if(temp === 'laskaback'){
                        path = "http://35.163.48.45:8888/laskaactivations/";
                    }
                    else{
                        path = "http://35.163.48.45:8888/laskaback/";
                    }

                    canvas.selectAll(".filters")
                            .attr("xlink:href",  function(d) { return path + d.img;});

                    return;

                });


        /************************************************
        *****boundary of filter boxes as button**********
        *************************************************/
        canvas.append("rect")
                .attr("class", "button")
                .attr("x", width - 120)
                .attr("y", 0 )
                .attr("rx", 5)
                .attr("ry", 5 )
                .attr("height", 30)
                .attr("width",  60 * 0.99)
                .attr("fill","navy")
                .on("click", down);

        canvas.append("text")
                .attr("class", "button")
                .attr("x", (width - 90))
                .attr("y", 15)
                .attr("dy", ".35em")
                .text("back")
                .attr("text-anchor", "middle")
                .style("cursor", "pointer")
                .attr("fill", "white")
                .on("click", down);



        /************************************************
        ********Individual images on second page*********
        *************************************************/
        var nodeEnter = canvas.selectAll("img")
                .data(d.Children)
                .enter();


        var filterEnter = nodeEnter.append("svg:image")
                .attr("class", "filters")
                .attr("name", "image")
                .attr("xlink:href",  function(d) { return path + d.img;})
                .attr("x", function (d, i) { return (i%divideBy) * widthBox})
                .attr("y", function (d, i) { return (Math.floor(i/divideBy) * widthBox )})
                .attr("height", (widthBox - widthBox * 0.01))
                .attr("width",  (widthBox - widthBox * 0.01))
                .attr("stroke-width", 2)
                .attr("stroke", "white")
                .on("mouseover", function(d) {
                    var shoop = JSON.stringify(d, ["id"]);
                    shoop = shoop.replace (/,"/g,"<br>");
                    shoop = shoop.replace(/[{}]/g, "");
                    shoop = shoop.replace(/"/g, "");
                    shoop = shoop.replace(/:/g," : " );
                    var leftshift = parseInt(d3.select(this).attr("x")) + boxwidth/2;
                    leftshift = leftshift.toString()
                    div.transition()
                            .duration(200)
                            .style("opacity", .9);

                    //replacing the content of hover here
                    div	.html(shoop)
                            .style("left", leftshift + "px")
                            .style("top", d3.select(this).attr("y")  + "px");
                    //console.log(d);
                    canvas.selectAll("img")
                            .data([d])
                            .enter()
                            .append("svg:image")
                            .attr("class", "tooltip")
                            .attr("xlink:href",  function(d) { return "http://35.163.48.45:8888/laskaback/" + d.img;})
                            .attr("x", width * 0.8 + widthBox*0.1)
                            .attr("y", 35 + (width * 0.2))
                            .attr("height", (width * 0.2 - widthBox*0.1))
                            .attr("width",  (width * 0.2 - widthBox*0.1));

                    canvas.selectAll("img")
                            .data([d])
                            .enter()
                            .append("svg:image")
                            .attr("class", "tooltip")
                            .attr("xlink:href",  function(d) { return "http://35.163.48.45:8888/laskaactivations/" + d.img;})
                            .attr("x", width * 0.8 + widthBox*0.1)
                            .attr("y", 235 + (width * 0.2))
                            .attr("height", (width * 0.2 - widthBox*0.1))
                            .attr("width",  (width * 0.2 - widthBox*0.1));
                })
                .on("mouseout", function(d) {
                    div.transition()
                            .duration(500)
                            .style("opacity", 0);
                    var offscreen = canvas.selectAll(".tooltip")
                            .remove();
                })
                .on("click", function (d) {
                    d.good = 1;
                })
                .on("dblclick", function (d) {
                    //hshere
                    //store annotations
                    d.bad = 1;
                });



        canvas.selectAll("img")
                .data([1])
                .enter()
                .append("svg:image")
                .attr("class", "panel")
                .attr("xlink:href",  function(d) { return path +"laska.png";})
                .attr("x", width * 0.8 + widthBox*0.1)
                .attr("y", 35)
                .attr("height", (width * 0.2 - widthBox*0.1))
                .attr("width",  (width * 0.2 - widthBox*0.1));

    }


 






</script>




<div id='stacked-bar'></div>

<script>
var initStackedBarChart = {
    draw: function(config) {
        me = this,
        domEle = config.element,
        stackKey = config.key,
        data = config.data,
        margin = {top: 5, right: 0, bottom: 5, left: 5},
        parseDate = d3.timeParse("%m/%Y"),
        width = (60 * 0.9) - 5;
        height = 30 - 5;
        xScale = d3.scaleLinear().rangeRound([0, width]),
        yScale = d3.scaleBand().rangeRound([height, 0]).padding(0.1),
        color = d3.scaleOrdinal(d3.schemeCategory20),

        svg = d3.select("#"+domEle).append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var stack = d3.stack()
            .keys(stackKey)
            /*.order(d3.stackOrder)*/
            .offset(d3.stackOffsetNone);
    
        var layers= stack(data);
            //yScale.domain(data.map(function(d) { return parseDate(d.date); }));
            xScale.domain([0, d3.max(layers[layers.length - 1], function(d) { return d[0] + d[1]; }) ]).nice();

        var layer = svg.selectAll(".layer")
            .data(layers)
            .enter().append("g")
            .attr("class", "layer")
            .style("fill", function(d, i) { return color(i); });

          layer.selectAll("rect")
              .data(function(d) { return d; })
            .enter().append("rect")
              .attr("x", function(d) { return xScale(d[0]); })
              .attr("height", height + margin.top + margin.bottom)
              .attr("width", function(d) { return xScale(d[1]) - xScale(d[0]) });
                          
    }
}
var data = [{"disease":2761,"wounds":383,"other":324}];


var key = ["wounds", "other", "disease"];
initStackedBarChart.draw({
    data: data,
    key: key,
    element: 'stacked-bar'
});
</script>










</body>

</html>